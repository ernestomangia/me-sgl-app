@model ME.Libros.Web.Models.VentaViewModel

<h3>Nueva venta</h3>
@using (Html.BeginForm("Crear", "VentaVigente", FormMethod.Post, new { id = "formVentaVigente", @class = "form-horizontal formEntidad" }))
{
    @Html.Partial("Shared/Form_Partial", Model)

    <div class="row">
        <div class="col-md-10">
            <div class="alert alert-danger validationSummary @(ViewData.ModelState.IsValid ? "hide" : "")" role="alert">
                <a class="close" data-hide="alert" aria-hidden="true">×</a>
                <b>Mensajes:</b>
                @Html.Raw(HttpUtility.HtmlDecode(Html.ValidationSummary().ToString()))
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10">
            <div class="text-right">
                <a id="btnCancelar" class="btn btn-default" href="@Url.Action("Index")">
                    <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-success">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    Crear
                </button>
            </div>
        </div>
    </div>
    @*<input type="text" name="Items[0].ProductoId" value="" />
        <input type="text" name="Items[0].Cantidad" value="" />
        <input type="hidden" name="Items[0].Monto" value="0" />*@
}


@{
    Html.RenderAction("CrearItem");
}

<script type="text/javascript">
    $(document).ready(function () {
        //$("#btnAceptarVentaItem").on("click", function () {
        //    var productoId = $("#ProductoId").val();
        //    var cantidad = $("#Cantidad").val();

        //    //Buscar datos del producto AJAX
        //    //Validar Stock

        //    var table = $("#ventaDetalleTable").DataTable();
        //    table.row.add([
        //    "Codigo",
        //    "Diccionario",
        //    productoId,
        //    cantidad,
        //    "100,00",
        //    "200,00"
        //    ]).draw();

        //    $("#modalAgregarItem").showModalDialog("toggle");
        //});
        $("#formVentaItem").on("submit", function (e) {
            e.preventDefault();
            if ($("#formVentaItem").valid()) {
                $.ajax({
                    method: "POST",
                    url: $(this).attr("action"),
                    data: $(this).serialize(),
                    dataType: "json",
                    error: function (jqXhr, status, error) {
                        mensajeError("Ha ocurrido un error");
                    },
                    success: function (data) {
                        if (data.Success) {
                            var table = $("#ventaDetalleTable").DataTable();
                            table.row.add([
                            "Codigo",
                            "Diccionario",
                            "Test",
                            "Test",
                            "100,00",
                            "200,00"
                            ]).draw();
                            $('#modalAgregarItem').modal('toggle');
                            mensajeSuccess("Se agrego el producto al detalle de la venta");
                        } else {
                            var errores = "<ul>";
                            $.each(data.Errors, function (key, value) {
                                $.each(value.Value, function (key2, value2) {
                                    errores += "<li>" + value2 + "</li>";
                                });
                            });
                            errores += "</ul>";
                            $(".modalEliminar .validationSummary").append(errores);
                            $(".modalEliminar .validationSummary").removeClass("hide");
                        }
                    },
                    timeout: 10000,
                    cache: false
                });
            }
            //return false;
        });

    });

    function successAgregarVentaItem(data) {
        var table = $("#ventaDetalleTable").DataTable();
        table.row.add([
        "Codigo",
        "Diccionario",
        "Test",
        "Test",
        "100,00",
        "200,00"
        ]).draw();

        $("#modalAgregarItem").showModalDialog("toggle");
        mensajeSuccess("Se agrego el producto al detalle de la venta");
    }

    function errorAgregarVentaItem(data) {
        var errores = "<ul>";
        $.each(data.Errors, function (key, value) {
            $.each(value.Value, function (key2, value2) {
                errores += "<li>" + value2 + "</li>";
            });
        });
        errores += "</ul>";
        $("#modalAgregarItem .validationSummary").append(errores);
        $("#modalAgregarItem .validationSummary").removeClass("hide");
    }
</script>