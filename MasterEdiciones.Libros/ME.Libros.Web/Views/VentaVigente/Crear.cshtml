@model ME.Libros.Web.Models.VentaViewModel

<h3>Nueva venta</h3>
@using (Html.BeginForm("Crear", "VentaVigente", FormMethod.Post, new { id = "formVenta", @class = "form-horizontal formEntidad" }))
{
    @Html.Partial("Shared/Form_Partial", Model)

    <div class="row">
        <div class="col-md-10">
            <div class="alert alert-danger validationSummary @(ViewData.ModelState.IsValid ? "hide" : "")" role="alert">
                <a class="close" data-hide="alert" aria-hidden="true">×</a>
                <b>Mensajes:</b>
                @Html.Raw(HttpUtility.HtmlDecode(Html.ValidationSummary().ToString()))
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10">
            <div class="text-right">
                <a id="btnCancelar" class="btn btn-default" href="@Url.Action("Index")">
                    <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                    Cancelar
                </a>
                <button id="btnCrearVenta" name="btnCrearVenta" type="submit" class="btn btn-success">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    Crear
                </button>
            </div>
        </div>
    </div>
    @Html.ValidationSummary()
}
<input id="itemsIndex" type="hidden" name="Cantidad" value="0" />

@{ Html.RenderAction("CrearItem"); }

<script type="text/javascript">
    $(document).ready(function () {
        //$("#btnCrearVenta").on("click", function(e) {
        //    e.preventDefault();
        //    $("#formVentaItem").remove();
        //    $("#formVenta").submit();
        //});

        $("#formVentaItem").on("submit", function (e) {
            e.preventDefault();
            if ($("#formVentaItem").valid()) {
                $(".modalAgregarItem .validationSummary").addClass("hide");
                $(".modalAgregarItem .validationSummary ul").remove();
                $.ajax({
                    method: "POST",
                    url: $(this).attr("action"),
                    data: $(this).serialize(),
                    dataType: "json",
                    error: function (jqXhr, status, error) {
                        mensajeError("Ha ocurrido un error");
                    },
                    success: function (data) {
                        if (data.Success) {
                            var ventaItem = data.VentaItem;
                            agregarVentaItem(ventaItem);
                            $('#modalAgregarItem').modal('toggle');
                            mensajeSuccess("Se agrego el " + ventaItem.Producto.Nombre + " al detalle de la venta");
                        } else {
                            var errores = "<ul>";
                            $.each(data.Errors, function (key, value) {
                                $.each(value.Value, function (key2, value2) {
                                    errores += "<li>" + value2 + "</li>";
                                });
                            });
                            errores += "</ul>";
                            $(".modalAgregarItem .validationSummary").append(errores);
                            $(".modalAgregarItem .validationSummary").removeClass("hide");
                        }
                    },
                    timeout: 10000,
                    cache: false
                });
            }
        });

        $('#modalAgregarItem').on('hidden.bs.modal', function () {
            $(this).find(".validationSummary").addClass("hide");
            //$(this).find(".validationSummary ul").remove();
            $('#formVentaItem').each(function () {
                this.reset();
            });
            $(this).find('.form-group').each(function () {
                $(".form-group").removeClass("has-error has-success");
            });
        });


        //$("#formVentaItem").validate({
        //    errorLabelContainer: "#modalAgregarItem .validationSummary",
        //    wrapper: "li",
        //    submitHandler: function (form) {

        //    }
        //});
    });

    function agregarVentaItem(ventaItem) {
        var indexItem = parseInt($("#itemsIndex").val());
        var modificar = getModificarButton(indexItem);
        var eliminar = getEliminarButton(indexItem);
        var table = $("#ventaDetalleTable").DataTable();

        table.row.add([
            indexItem + 1,
            ventaItem.Producto.Nombre,
            ventaItem.Cantidad,
            ventaItem.Producto.PrecioVenta,
            ventaItem.Monto,
            modificar + eliminar
        ]).draw();

        var hiddenProductoId = "<input id='Items[" + indexItem + "].ProductoId' type='hidden' name='Items[" + indexItem + "].ProductoId' value='" + ventaItem.ProductoId + "' />";
        var hiddenCantidad = "<input id='Items[" + indexItem + "].Cantidad' type='hidden' name='Items[" + indexItem + "].Cantidad' value='" + ventaItem.Cantidad + "' />";
        $("#formVenta").append(hiddenProductoId + hiddenCantidad);
        $("#itemsIndex").val(indexItem + 1);
    }

    function getModificarButton(indexItem) {
        return "<button class='btn btn-warning btn-sm btnModificar' type='button' onclick='modificarVentaItem(" + indexItem + ");' title='Modificar'>" +
            "<span class='glyphicon glyphicon-pencil' aria-hidden='true'></span>" +
            "</button>";
    }

    function getEliminarButton(indexItem) {
        return "<button class='btn btn-danger btn-sm btnEliminar' type='button' onclick='eliminarVentaItem(" + indexItem + ");'  title='Eliminar'>" +
            "<span class='glyphicon glyphicon-trash' aria-hidden='true'></span>" +
            "</button>";
    }

    function eliminarVentaItem(indexItem) {
        //indexItem = parseInt(indexItem);
        $("#Items[" + indexItem + "].ProductoId").remove();
        $("#Items[" + indexItem + "].Cantidad").remove();
        var table = $("#ventaDetalleTable").DataTable();
        table.row(indexItem).remove().draw();
        var cantidad = parseInt($("#itemsIndex").val());
        $("#itemsIndex").val(cantidad-1);
    }

    function modificarVentaItem(indexItem) {
    }

</script>